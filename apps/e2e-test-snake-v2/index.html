<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline'; connect-src https://8mag3jdi5f.execute-api.us-east-1.amazonaws.com; img-src 'self' data:; font-src 'self'; object-src 'none'; base-uri 'none'; form-action 'none';">
<script>
/* SingularityDB ‚Äî DO NOT MODIFY THIS BLOCK */
const SINGULARITY_DB_API = "https://8mag3jdi5f.execute-api.us-east-1.amazonaws.com/api/data";
const SINGULARITY_DB_NS = "e2e-test-snake-v2";
class SingularityDB {
  constructor(ns) { this.ns = ns; this.api = SINGULARITY_DB_API; }
  async get(key) {
    try {
      const r = await fetch(this.api + "/" + this.ns + "/" + encodeURIComponent(key));
      if (!r.ok) return null;
      return await r.json();
    } catch(e) { console.error("SingularityDB get error:", e); return null; }
  }
  async set(key, value) {
    try {
      const r = await fetch(this.api + "/" + this.ns + "/" + encodeURIComponent(key), {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({value: value})
      });
      return await r.json();
    } catch(e) { console.error("SingularityDB set error:", e); return {ok: false}; }
  }
  async delete(key) {
    try {
      const r = await fetch(this.api + "/" + this.ns + "/" + encodeURIComponent(key), {
        method: "DELETE"
      });
      return await r.json();
    } catch(e) { console.error("SingularityDB delete error:", e); return {ok: false}; }
  }
  async list() {
    try {
      const r = await fetch(this.api + "/" + this.ns);
      if (!r.ok) return [];
      return await r.json();
    } catch(e) { console.error("SingularityDB list error:", e); return []; }
  }
}
const db = new SingularityDB(SINGULARITY_DB_NS);
/* END SingularityDB */
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retro Snake Game</title>
    <style>
        :root {
            --bg: #0a0a0a;
            --cyan: #00d4ff;
            --green: #00ff41;
            --red: #ff0040;
            --text: #e0e0e0;
            --muted: #888;
            --border: #333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Courier New', monospace;
            display: grid;
            place-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            text-align: center;
            max-width: 600px;
            width: 100%;
            padding: 20px;
        }

        .loading {
            display: grid;
            place-items: center;
            height: 100vh;
            font-size: 24px;
            color: var(--cyan);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top: 3px solid var(--cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        h1 {
            font-size: clamp(2rem, 5vw, 3rem);
            color: var(--green);
            margin-bottom: 20px;
            text-shadow: 0 0 20px var(--green);
            animation: pulse 2s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            0% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .game-container {
            position: relative;
            display: inline-block;
            border: 2px solid var(--cyan);
            border-radius: 8px;
            background: #111;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
            margin-bottom: 20px;
        }

        #gameCanvas {
            display: block;
            background: #000;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(2, 60px);
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .control-btn {
            background: var(--border);
            border: 2px solid var(--cyan);
            color: var(--cyan);
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: grid;
            place-items: center;
            user-select: none;
        }

        .control-btn:hover, .control-btn:active {
            background: var(--cyan);
            color: var(--bg);
            transform: scale(0.95);
        }

        .control-btn:nth-child(1) { grid-column: 2; grid-row: 1; }
        .control-btn:nth-child(2) { grid-column: 1; grid-row: 2; }
        .control-btn:nth-child(3) { grid-column: 3; grid-row: 2; }
        .control-btn:nth-child(4) { grid-column: 2; grid-row: 2; }

        .info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 18px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .score {
            color: var(--green);
            font-weight: bold;
        }

        .high-score {
            color: var(--cyan);
            font-weight: bold;
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 12px;
            border: 2px solid var(--red);
            text-align: center;
            box-shadow: 0 0 40px rgba(255, 0, 64, 0.5);
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .game-over h2 {
            color: var(--red);
            font-size: 24px;
            margin-bottom: 15px;
        }

        .restart-btn {
            background: var(--green);
            border: none;
            color: var(--bg);
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 15px;
        }

        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 65, 0.4);
        }

        .leaderboard {
            background: rgba(51, 51, 51, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--border);
            backdrop-filter: blur(5px);
        }

        .leaderboard h3 {
            color: var(--cyan);
            margin-bottom: 15px;
            font-size: 20px;
        }

        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .leaderboard-entry:last-child {
            border-bottom: none;
        }

        .leaderboard-entry:hover {
            background: rgba(0, 212, 255, 0.1);
            padding-left: 10px;
        }

        .instructions {
            font-size: 14px;
            color: var(--muted);
            margin-top: 20px;
            line-height: 1.5;
        }

        .new-record {
            animation: flash 0.5s ease-in-out 3;
        }

        @keyframes flash {
            0%, 100% { background: transparent; }
            50% { background: rgba(0, 255, 65, 0.2); }
        }

        @media (max-width: 480px) {
            .container { padding: 10px; }
            .info { justify-content: center; }
            .controls { grid-template-columns: repeat(3, 50px); grid-template-rows: repeat(2, 50px); }
            .control-btn { font-size: 16px; }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Loading Snake Game...</div>
    </div>

    <div class="container" id="gameContainer" style="display: none;">
        <h1>üêç RETRO SNAKE</h1>
        
        <div class="info">
            <div class="score">Score: <span id="currentScore">0</span></div>
            <div class="high-score">High Score: <span id="highScore">0</span></div>
        </div>

        <div class="game-container">
            <canvas id="gameCanvas" width="400" height="400"></canvas>
            <div class="game-over" id="gameOver" style="display: none;">
                <h2>GAME OVER</h2>
                <div>Final Score: <span id="finalScore">0</span></div>
                <div id="recordMessage" style="color: var(--green); margin: 10px 0;"></div>
                <button class="restart-btn" onclick="restartGame()">PLAY AGAIN</button>
            </div>
        </div>

        <div class="controls">
            <button class="control-btn" onclick="changeDirection('up')" id="upBtn">‚Üë</button>
            <button class="control-btn" onclick="changeDirection('left')" id="leftBtn">‚Üê</button>
            <button class="control-btn" onclick="changeDirection('right')" id="rightBtn">‚Üí</button>
            <button class="control-btn" onclick="changeDirection('down')" id="downBtn">‚Üì</button>
        </div>

        <div class="leaderboard">
            <h3>üèÜ LEADERBOARD</h3>
            <div id="leaderboardList">
                <div style="color: var(--muted); text-align: center; padding: 20px;">
                    Loading scores...
                </div>
            </div>
        </div>

        <div class="instructions">
            Use arrow keys or touch controls to move the snake.<br>
            Eat the red food to grow and increase your score!
        </div>
    </div>

    <a href="https://singularityengine.ai" style="position:fixed;bottom:8px;right:12px;font-size:11px;color:#333;text-decoration:none;font-family:system-ui;z-index:9999;opacity:0.5" onmouseover="this.style.opacity='1';this.style.color='#00d4ff'" onmouseout="this.style.opacity='0.5';this.style.color='#333'">Built by Singularity Engine ü§ñ</a>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 20;
        const tileCount = canvas.width / gridSize;

        let snake = [{ x: 10, y: 10 }];
        let food = {};
        let dx = 0;
        let dy = 0;
        let score = 0;
        let gameRunning = false;
        let highScore = 0;

        // Sound effects using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(frequency, duration, type = 'sine') {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = type;
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + duration);
        }

        function generateFood() {
            food = {
                x: Math.floor(Math.random() * tileCount),
                y: Math.floor(Math.random() * tileCount)
            };
            
            // Ensure food doesn't spawn on snake
            for (let segment of snake) {
                if (segment.x === food.x && segment.y === food.y) {
                    generateFood();
                    return;
                }
            }
        }

        function drawGame() {
            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw snake
            ctx.fillStyle = '#00ff41';
            ctx.shadowColor = '#00ff41';
            ctx.shadowBlur = 10;
            for (let segment of snake) {
                ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 2, gridSize - 2);
            }
            ctx.shadowBlur = 0;

            // Draw food
            ctx.fillStyle = '#ff0040';
            ctx.shadowColor = '#ff0040';
            ctx.shadowBlur = 15;
            ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 2, gridSize - 2);
            ctx.shadowBlur = 0;
        }

        function moveSnake() {
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };

            // Check wall collision
            if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
                gameOver();
                return;
            }

            // Check self collision
            for (let segment of snake) {
                if (head.x === segment.x && head.y === segment.y) {
                    gameOver();
                    return;
                }
            }

            snake.unshift(head);

            // Check food collision
            if (head.x === food.x && head.y === food.y) {
                score += 10;
                document.getElementById('currentScore').textContent = score;
                playSound(440, 0.1); // Eat sound
                generateFood();
            } else {
                snake.pop();
            }
        }

        function gameLoop() {
            if (!gameRunning) return;

            moveSnake();
            drawGame();
            
            setTimeout(gameLoop, 150 - Math.floor(score / 50) * 10); // Speed increases with score
        }

        function startGame() {
            snake = [{ x: 10, y: 10 }];
            dx = 1;
            dy = 0;
            score = 0;
            gameRunning = true;
            document.getElementById('currentScore').textContent = score;
            document.getElementById('gameOver').style.display = 'none';
            generateFood();
            gameLoop();
        }

        async function gameOver() {
            gameRunning = false;
            playSound(200, 0.5, 'sawtooth'); // Game over sound
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('gameOver').style.display = 'block';

            // Check if new high score
            if (score > highScore) {
                highScore = score;
                document.getElementById('highScore').textContent = highScore;
                document.getElementById('recordMessage').textContent = 'üéâ NEW HIGH SCORE! üéâ';
                document.getElementById('recordMessage').classList.add('new-record');
                
                // Save high score
                await db.set('highScore', highScore);
                
                // Add to leaderboard
                const timestamp = new Date().toISOString();
                const leaderboardEntry = { score: score, date: timestamp };
                await db.set(`score_${timestamp}`, leaderboardEntry);
                
                updateLeaderboard();
            } else {
                document.getElementById('recordMessage').textContent = '';
            }
        }

        function restartGame() {
            document.getElementById('recordMessage').classList.remove('new-record');
            startGame();
        }

        function changeDirection(direction) {
            if (!gameRunning) {
                startGame();
                return;
            }

            switch (direction) {
                case 'up':
                    if (dy === 0) { dx = 0; dy = -1; }
                    break;
                case 'down':
                    if (dy === 0) { dx = 0; dy = 1; }
                    break;
                case 'left':
                    if (dx === 0) { dx = -1; dy = 0; }
                    break;
                case 'right':
                    if (dx === 0) { dx = 1; dy = 0; }
                    break;
            }
        }

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            switch (e.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    e.preventDefault();
                    changeDirection('up');
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    e.preventDefault();
                    changeDirection('down');
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    e.preventDefault();
                    changeDirection('left');
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    e.preventDefault();
                    changeDirection('right');
                    break;
                case ' ':
                    e.preventDefault();
                    if (!gameRunning) restartGame();
                    break;
            }
        });

        async function updateLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            
            try {
                const allData = await db.list();
                const scores = allData
                    .filter(item => item.key.startsWith('score_'))
                    .map(item => item.value)
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 5);

                if (scores.length === 0) {
                    leaderboardList.innerHTML = '<div style="color: var(--muted); text-align: center; padding: 20px;">No scores yet. Play a game!</div>';
                    return;
                }

                leaderboardList.innerHTML = scores.map((entry, index) => `
                    <div class="leaderboard-entry">
                        <span>${index + 1}. Score: ${entry.score}</span>
                        <span style="color: var(--muted); font-size: 12px;">${new Date(entry.date).toLocaleDateString()}</span>
                    </div>
                `).join('');
            } catch (error) {
                leaderboardList.innerHTML = '<div style="color: var(--red); text-align: center; padding: 20px;">Error loading leaderboard</div>';
            }
        }

        async function initGame() {
            try {
                // Load high score
                const savedHighScore = await db.get('highScore');
                if (savedHighScore) {
                    highScore = savedHighScore;
                    document.getElementById('highScore').textContent = highScore;
                }

                // Load leaderboard
                await updateLeaderboard();

                // Hide loading screen and show game
                document.getElementById('loading').style.display = 'none';
                document.getElementById('gameContainer').style.display = 'block';

                // Start with initial game state
                generateFood();
                drawGame();
                
                // Show instructions for first-time players
                if (!savedHighScore) {
                    setTimeout(() => {
                        alert('üêç Welcome to Retro Snake!\n\nUse arrow keys or touch controls to move.\nEat red food to grow and score points.\nAvoid walls and your own tail!\n\nPress any arrow key or touch a control to start!');
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Failed to initialize game:', error);
                document.getElementById('loading').innerHTML = '<div style="color: var(--red);">Failed to load game</div>';
            }
        }

        // Initialize game when page loads
        window.addEventListener('load', initGame);

        // Handle touch events for mobile
        let touchStartX = null;
        let touchStartY = null;

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });

        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            if (!touchStartX || !touchStartY) return;

            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;

            const diffX = touchStartX - touchEndX;
            const diffY = touchStartY - touchEndY;

            if (Math.abs(diffX) > Math.abs(diffY)) {
                if (diffX > 0) {
                    changeDirection('left');
                } else {
                    changeDirection('right');
                }
            } else {
                if (diffY > 0) {
                    changeDirection('up');
                } else {
                    changeDirection('down');
                }
            }

            touchStartX = null;
            touchStartY = null;
        });
    </script>
</body>
</html>